{% extends "base.html" %}

{% block tieu_de %}Qu·∫£n L√Ω Thu Chi{% endblock %}

{% block extra_css %}
<!-- Modal Fix CSS cho mobile/iOS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal_fix.css') }}">

<style>
/* CSS c·∫≠p nh·∫≠t - v2.0 */
/* CSS t√πy ch·ªânh cho b·∫£ng chi ti√™u responsive */
.card {
    overflow: hidden;
    border-radius: 8px;
    max-width: 100%;
    box-sizing: border-box;
}

.table-container {
    width: 100%;
    overflow: hidden;
    max-width: 100%;
    position: relative;
}

.table {
    width: 100% !important;
    table-layout: fixed;
    margin-bottom: 0;
    max-width: 100%;
    box-sizing: border-box;
}

.card-body {
    padding: 0 !important;
    overflow: hidden;
    max-width: 100%;
}

/* Force table to stay within bounds */
.table th,
.table td {
    box-sizing: border-box;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 0; /* Force ellipsis */
}

/* CSS ri√™ng cho b·∫£ng thu chi */
.table-thu-chi {
    table-layout: fixed !important;
    width: 100% !important;
    border-collapse: collapse !important;
}

.table-thu-chi th,
.table-thu-chi td {
    padding: 0.5rem 0.3rem !important;
    font-size: 0.85rem !important;
    vertical-align: middle !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    max-width: 0 !important; /* Force text truncation */
    border: 1px solid #dee2e6 !important;
}

/* Desktop - 6 c·ªôt v·ªõi text truncation */
.table-thu-chi th:nth-child(1), .table-thu-chi td:nth-child(1) { 
    width: 12% !important; 
    max-width: 12% !important;
} /* Ng√†y */

.table-thu-chi th:nth-child(2), .table-thu-chi td:nth-child(2) { 
    width: 10% !important; 
    max-width: 10% !important;
} /* Lo·∫°i */

.table-thu-chi th:nth-child(3), .table-thu-chi td:nth-child(3) { 
    width: 25% !important; 
    max-width: 25% !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
} /* Ti√™u ƒë·ªÅ - r√∫t g·ªçn khi d√†i */

.table-thu-chi th:nth-child(4), .table-thu-chi td:nth-child(4) { 
    width: 18% !important; 
    max-width: 18% !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
} /* Danh m·ª•c - r√∫t g·ªçn khi d√†i */

.table-thu-chi th:nth-child(5), .table-thu-chi td:nth-child(5) { 
    width: 20% !important; 
    max-width: 20% !important;
    text-align: right !important;
    white-space: nowrap !important;
} /* S·ªë ti·ªÅn */

.table-thu-chi th:nth-child(6), .table-thu-chi td:nth-child(6) { 
    width: 15% !important; 
    max-width: 15% !important;
    text-align: center !important;
} /* Thao t√°c */

@media screen and (max-width: 768px) {
    /* TEST: M√†u n·ªÅn ƒë·ªÉ ki·ªÉm tra CSS mobile c√≥ √°p d·ª•ng */
    body {
        background-color: #ffeeee !important;
    }
    
    /* Force CSS mobile cho b·∫£ng thu chi v·ªõi specificity cao */
    .card .card-body .table-container .table-thu-chi {
        table-layout: fixed !important;
        width: 100% !important;
        font-size: 0.55rem !important;
        background-color: #ffffcc !important;
        border-collapse: collapse !important;
    }
    
    .card .card-body .table-container .table-thu-chi th,
    .card .card-body .table-container .table-thu-chi td {
        padding: 0.15rem 0.05rem !important;
        font-size: 0.5rem !important;
        line-height: 1.0 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 0 !important;
        border: 1px solid #ccc !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
    }
    
    /* Mobile - Force width cho t·ª´ng c·ªôt */
    .card .card-body .table-container .table-thu-chi th:nth-child(1), 
    .card .card-body .table-container .table-thu-chi td:nth-child(1) { 
        width: 12% !important; 
        max-width: 12% !important;
        min-width: 12% !important;
        background-color: #ffcccc !important;
    } /* Ng√†y */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(2), 
    .card .card-body .table-container .table-thu-chi td:nth-child(2) { 
        width: 10% !important; 
        max-width: 10% !important;
        min-width: 10% !important;
        background-color: #ccffcc !important;
    } /* Lo·∫°i */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(3), 
    .card .card-body .table-container .table-thu-chi td:nth-child(3) { 
        width: 25% !important; 
        max-width: 25% !important;
        min-width: 25% !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        background-color: #ccccff !important;
    } /* Ti√™u ƒë·ªÅ */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(4), 
    .card .card-body .table-container .table-thu-chi td:nth-child(4) { 
        width: 15% !important; 
        max-width: 15% !important;
        min-width: 15% !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        background-color: #ffffcc !important;
    } /* Danh m·ª•c */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(5), 
    .card .card-body .table-container .table-thu-chi td:nth-child(5) { 
        width: 20% !important; 
        max-width: 20% !important;
        min-width: 20% !important;
        text-align: right !important;
        white-space: nowrap !important;
        background-color: #ffccff !important;
    } /* S·ªë ti·ªÅn */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(6), 
    .card .card-body .table-container .table-thu-chi td:nth-child(6) { 
        width: 18% !important; 
        max-width: 18% !important;
        min-width: 18% !important;
        text-align: center !important;
        background-color: #ccffff !important;
    } /* Thao t√°c */
    
    /* ƒê·∫£m b·∫£o container kh√¥ng overflow tr√™n mobile */
    .card {
        max-width: 100vw !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
    }
    
    .table-container {
        width: 100% !important;
        overflow: hidden !important;
        max-width: 100% !important;
    }
    
    .card-body {
        padding: 0 !important;
        overflow: hidden !important;
        max-width: 100% !important;
    }
    
    /* Force table buttons nh·ªè */
    .table-thu-chi .btn {
        padding: 0.1rem 0.15rem !important;
        font-size: 0.5rem !important;
        margin: 0 !important;
        min-width: auto !important;
        width: auto !important;
        line-height: 1 !important;
    }
    
    .table-thu-chi .btn i {
        font-size: 0.5rem !important;
    }
    
    /* L√†m c√°c button c·ª±c nh·ªè */
    .table .btn {
        padding: 0.1rem 0.2rem !important;
        font-size: 0.55rem !important;
        margin: 0 !important;
        min-width: auto !important;
        width: auto !important;
    }
    
    .table .btn i {
        font-size: 0.6rem !important;
    }
    
    /* Force container width */
    .col-12 {
        max-width: 100% !important;
        overflow: hidden !important;
    }
    
    /* CSS cho n√∫t Thu Nh·∫≠p v√† Chi Ti√™u sang ph·∫£i tr√™n mobile */
    .d-flex.gap-2 {
        justify-content: flex-end !important;
        margin-left: auto !important;
    }
    
    /* ƒê·∫£m b·∫£o header container responsive */
    .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.align-items-md-center.gap-2 {
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.align-items-md-center.gap-2 .d-flex.gap-2 {
        justify-content: flex-end !important;
        margin-left: auto !important;
        flex-shrink: 0 !important;
    }
}

@media (min-width: 769px) {
    .table th,
    .table td {
        padding: 0.5rem 0.3rem;
    }
    
    .table th:nth-child(1) { width: 12%; } /* Ng√†y */
    .table th:nth-child(2) { width: 10%; } /* Lo·∫°i */
    .table th:nth-child(3) { width: 25%; } /* Ti√™u ƒë·ªÅ */
    .table th:nth-child(4) { width: 18%; } /* Danh m·ª•c */
    .table th:nth-child(5) { width: 15%; } /* S·ªë ti·ªÅn */
    .table th:nth-child(6) { width: 20%; } /* Thao t√°c */
}

/* ƒê·∫£m b·∫£o kh√¥ng c√≥ overflow */
.container-fluid {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
    max-width: 100vw;
    overflow-x: hidden;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 0.25rem !important;
        padding-right: 0.25rem !important;
    }
    
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Force no horizontal scroll */
body {
    overflow-x: hidden;
}

html {
    overflow-x: hidden;
}
</style>
{% endblock %}

{% block noi_dung %}
<div class="chi-tieu-page">
<div class="container-fluid px-2 px-md-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <div>
                    <h1 class="h3 text-primary">
                        <i class="fas fa-chart-line me-2"></i>
                        <span>Qu·∫£n L√Ω Thu Chi</span>
                    </h1>  
                </div>
                <div class="d-flex gap-2" style="margin-left: auto !important; justify-content: flex-end !important;">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-them-thu">
                        <i class="fas fa-plus me-1"></i>
                        <span class="d-none d-sm-inline">Thu Nh·∫≠p</span>
                        <span class="d-sm-none">Thu</span>
                    </button>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modal-them-chi">
                        <i class="fas fa-minus me-1"></i>
                        <span class="d-none d-sm-inline">Chi Ti√™u</span>
                        <span class="d-sm-none">Chi</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Th·ªëng k√™ nhanh -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Thu Nh·∫≠p</h6>
                    <p class="card-text h5" id="tong-thu-thang">
                        <small class="d-block text-white-50">Th√°ng n√†y</small>
                        0 VNƒê
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Chi Ti√™u</h6>
                    <p class="card-text h5" id="tong-chi-thang">
                        <small class="d-block text-white-50">Th√°ng n√†y</small>
                        0 VNƒê
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">S·ªë D∆∞</h6>
                    <p class="card-text h5" id="so-du">
                        <small class="d-block text-white-50">S·ªë d∆∞</small>
                        0 VNƒê
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Thu H√¥m Nay</h6>
                    <p class="card-text h5" id="thu-hom-nay">
                        <small class="d-block text-white-50">H√¥m nay</small>
                        0 VNƒê
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Chi H√¥m Nay</h6>
                    <p class="card-text h5" id="chi-hom-nay">
                        <small class="d-block text-white-50">H√¥m nay</small>
                        0 VNƒê
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-secondary text-white">
                <div class="card-body">
                    <h6 class="card-title">Giao D·ªãch</h6>
                    <p class="card-text h5" id="so-giao-dich">
                        <small class="d-block text-white-50">T·ªïng</small>
                        0
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh s√°ch thu chi -->
    <div class="row mx-0">
        <div class="col-12 px-1 px-md-3">
            <div class="card mx-0">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                    <h5 class="card-title mb-0 mb-md-0">
                        <i class="fas fa-list me-2"></i>
                        Danh S√°ch Thu Chi
                    </h5>
                    <!-- B·ªô l·ªçc nh·ªè g·ªçn b√™n g√≥c ph·∫£i -->
                    <div class="d-flex gap-1 gap-md-2 align-items-center flex-wrap">
                        <select class="form-select form-select-sm" id="loc-loai" style="width: 75px;" onchange="loc_du_lieu()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="thu">Thu nh·∫≠p</option>
                            <option value="chi">Chi ti√™u</option>
                        </select>
                        <select class="form-select form-select-sm" id="loc-danh-muc" style="width: 100px;" onchange="loc_du_lieu()">
                            <option value="">Danh m·ª•c</option>
                            <!-- S·∫Ω ƒë∆∞·ª£c load t·ª´ localStorage b·∫±ng JavaScript -->
                        </select>
                        <input type="date" class="form-control form-control-sm d-none d-md-inline" id="tu-ngay" style="width: 125px;" onchange="loc_du_lieu()" title="T·ª´ ng√†y" placeholder="T·ª´ ng√†y">
                        <input type="date" class="form-control form-control-sm d-none d-md-inline" id="den-ngay" style="width: 125px;" onchange="loc_du_lieu()" title="ƒê·∫øn ng√†y" placeholder="ƒê·∫øn ng√†y">
                        <button class="btn btn-outline-secondary btn-sm" onclick="xoa_bo_loc()" title="X√≥a b·ªô l·ªçc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-container">
                        <table class="table table-hover w-100 mb-0 table-thu-chi" style="table-layout: fixed !important; width: 100% !important; font-size: 0.55rem;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 12% !important; max-width: 12% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Ng√†y</th>
                                    <th style="width: 10% !important; max-width: 10% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Lo·∫°i</th>
                                    <th style="width: 25% !important; max-width: 25% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Ti√™u ƒë·ªÅ</th>
                                    <th style="width: 15% !important; max-width: 15% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Danh m·ª•c</th>
                                    <th style="width: 20% !important; max-width: 20% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: right;">S·ªë ti·ªÅn</th>
                                    <th style="width: 18% !important; max-width: 18% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="danh-sach-thu-chi">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal th√™m thu nh·∫≠p -->
<div class="modal fade" id="modal-them-thu" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>
                    Th√™m Thu Nh·∫≠p
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-them-thu">
                    <div class="mb-3">
                        <label class="form-label">S·ªë ti·ªÅn <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="so-tien-thu" placeholder="0" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                        <select class="form-control" id="danh-muc-thu" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                            <!-- S·∫Ω ƒë∆∞·ª£c load t·ª´ localStorage b·∫±ng JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ng√†y thu</label>
                        <input type="date" class="form-control" id="ngay-thu">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="mo-ta-thu" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="them_thu_nhap()">
                    <i class="fas fa-save me-1"></i>L∆∞u Thu Nh·∫≠p
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal th√™m chi ti√™u -->
<div class="modal fade" id="modal-them-chi" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-minus-circle me-2"></i>
                    Th√™m Chi Ti√™u
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-them-chi">
                    <div class="mb-3">
                        <label class="form-label">S·ªë ti·ªÅn <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="so-tien-chi" placeholder="0" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                        <select class="form-control" id="danh-muc-chi" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                            <!-- S·∫Ω ƒë∆∞·ª£c load t·ª´ localStorage b·∫±ng JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ng√†y chi</label>
                        <input type="date" class="form-control" id="ngay-chi">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="mo-ta-chi" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" onclick="them_chi_tieu()">
                    <i class="fas fa-save me-1"></i>L∆∞u Chi Ti√™u
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    // Kh·ªüi t·∫°o khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
        const hom_nay = new Date().toISOString().split('T')[0];
        document.getElementById('ngay-thu').value = hom_nay;
        document.getElementById('ngay-chi').value = hom_nay;
        document.getElementById('den-ngay').value = hom_nay;
        
        // ƒê·∫∑t t·ª´ ng√†y l√† ƒë·∫ßu th√°ng
        const dau_thang = new Date();
        dau_thang.setDate(1);
        document.getElementById('tu-ngay').value = dau_thang.toISOString().split('T')[0];
        
        // Load danh m·ª•c t·ª´ localStorage tr∆∞·ªõc
        tai_danh_muc_tu_localStorage();
        
        // T·∫£i d·ªØ li·ªáu
        tai_danh_sach_thu_chi();
        tinh_thong_ke();
        
        // L·∫Øng nghe thay ƒë·ªïi c√†i ƒë·∫∑t to√†n c·ª•c
        window.addEventListener('settingsChanged', function(event) {
            // Reload l·∫°i th·ªëng k√™ ƒë·ªÉ format l·∫°i ti·ªÅn t·ªá
            tinh_thong_ke();
            // Reload l·∫°i danh s√°ch ƒë·ªÉ format l·∫°i
            tai_danh_sach_thu_chi();
        });
    });

    async function tai_danh_sach_thu_chi() {
        try {
            const response = await fetch('/api/thu-chi');
            const data = await response.json();
            
            if (data.thanh_cong) {
                hien_thi_danh_sach_thu_chi(data.du_lieu);
            } else {
                throw new Error(data.loi);
            }
        } catch (error) {
            console.error('L·ªói t·∫£i danh s√°ch thu chi:', error);
            document.getElementById('danh-sach-thu-chi').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function hien_thi_danh_sach_thu_chi(danh_sach) {
        const tbody = document.getElementById('danh-sach-thu-chi');
        
        if (danh_sach.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                        <p class="text-muted">Ch∆∞a c√≥ giao d·ªãch n√†o</p>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modal-them-thu">
                                <i class="fas fa-plus me-1"></i>Thu nh·∫≠p
                            </button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modal-them-chi">
                                <i class="fas fa-minus me-1"></i>Chi ti√™u
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t tr∆∞·ªõc
        danh_sach.sort((a, b) => {
            const ngay_a = new Date(a.ngay_giao_dich || a.ngay_chi || a.ngay_tao);
            const ngay_b = new Date(b.ngay_giao_dich || b.ngay_chi || b.ngay_tao);
            return ngay_b - ngay_a; // Ng√†y m·ªõi nh·∫•t tr∆∞·ªõc
        });

        tbody.innerHTML = danh_sach.map(item => {
            // X√°c ƒë·ªãnh lo·∫°i giao d·ªãch t·ª´ d·ªØ li·ªáu ho·∫∑c m·∫∑c ƒë·ªãnh l√† chi ti√™u
            const loai = item.loai || 'chi';
            const ngay_hien_thi = item.ngay_giao_dich || item.ngay_chi || item.ngay_tao;
            
            return `
            <tr>
                <td style="width: 12% !important; max-width: 12% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <small>${dinh_dang_ngay(ngay_hien_thi)}</small>
                </td>
                <td style="width: 10% !important; max-width: 10% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <span class="badge ${loai === 'thu' ? 'bg-success' : 'bg-danger'}">
                        <i class="fas ${loai === 'thu' ? 'fa-plus' : 'fa-minus'} me-1"></i>
                        ${loai === 'thu' ? 'Thu' : 'Chi'}
                    </span>
                </td>
                <td title="${item.tieu_de}" style="width: 25% !important; max-width: 25% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <strong>${item.tieu_de}</strong>
                    ${item.mo_ta ? `<br><small class="text-muted">${item.mo_ta}</small>` : ''}
                </td>
                <td title="${lay_ten_danh_muc(item.danh_muc)}" style="width: 15% !important; max-width: 15% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <span class="badge bg-secondary">${lay_ten_danh_muc(item.danh_muc)}</span>
                </td>
                <td style="width: 20% !important; max-width: 20% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: right;">
                    <strong class="${loai === 'thu' ? 'text-success' : 'text-danger'}">
                        ${loai === 'thu' ? '+' : '-'}${dinh_dang_tien(item.so_tien)}
                    </strong>
                </td>
                <td style="width: 18% !important; max-width: 18% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;">
                    <button class="btn btn-sm btn-outline-danger" onclick="xoa_giao_dich(${item.id})" style="padding: 0.1rem 0.15rem !important; font-size: 0.45rem !important;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    async function them_thu_nhap() {
        const form = document.getElementById('form-them-thu');
        const submitButton = document.querySelector('#modal-them-thu .btn-success');
        
        // Clear previous validation errors
        if (window.clearModalValidationErrors) {
            window.clearModalValidationErrors('form-them-thu');
        }
        
        // Validation
        const so_tien = document.getElementById('so-tien-thu').value;
        const danh_muc = document.getElementById('danh-muc-thu').value;
        
        if (!so_tien || parseFloat(so_tien) <= 0) {
            if (window.showModalValidationError) {
                window.showModalValidationError('so-tien-thu', 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá');
            }
            return;
        }
        
        if (!danh_muc) {
            if (window.showModalValidationError) {
                window.showModalValidationError('danh-muc-thu', 'Vui l√≤ng ch·ªçn danh m·ª•c');
            }
            return;
        }

        // Set loading state
        if (window.setButtonLoading) {
            window.setButtonLoading(submitButton, true);
        }

        const danh_muc_element = document.getElementById('danh-muc-thu');
        const danh_muc_text = danh_muc_element.options[danh_muc_element.selectedIndex].text;
        const tieu_de_tu_dong = danh_muc_text.replace(/^\S+\s/, ''); // X√≥a emoji v√† kho·∫£ng tr·∫Øng ƒë·∫ßu
        
        const du_lieu = {
            loai: 'thu',
            tieu_de: tieu_de_tu_dong,
            so_tien: parseFloat(so_tien),
            danh_muc: danh_muc,
            ngay_giao_dich: document.getElementById('ngay-thu').value,
            mo_ta: document.getElementById('mo-ta-thu').value
        };

        try {
            const response = await fetch('/api/thu-chi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(du_lieu)
            });

            const result = await response.json();
            
            if (result.thanh_cong) {
                hien_thi_thong_bao('ƒê√£ th√™m thu nh·∫≠p m·ªõi!', 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-them-thu'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                form.reset();
                document.getElementById('ngay-thu').value = new Date().toISOString().split('T')[0];
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu ngay l·∫≠p t·ª©c
                await tai_danh_sach_thu_chi();
                await tinh_thong_ke();
                
                // N·∫øu ƒëang c√≥ b·ªô l·ªçc, √°p d·ª•ng l·∫°i b·ªô l·ªçc
                if (co_bo_loc_dang_hoat_dong()) {
                    loc_du_lieu();
                }
            } else {
                throw new Error(result.loi);
            }
        } catch (error) {
            console.error('L·ªói th√™m thu nh·∫≠p:', error);
            hien_thi_thong_bao(`L·ªói: ${error.message}`, 'error');
        } finally {
            // Remove loading state
            if (window.setButtonLoading) {
                window.setButtonLoading(submitButton, false);
            }
        }
    }

    async function them_chi_tieu() {
        const form = document.getElementById('form-them-chi');
        const submitButton = document.querySelector('#modal-them-chi .btn-danger');
        
        // Clear previous validation errors
        if (window.clearModalValidationErrors) {
            window.clearModalValidationErrors('form-them-chi');
        }
        
        // Validation
        const so_tien = document.getElementById('so-tien-chi').value;
        const danh_muc = document.getElementById('danh-muc-chi').value;
        
        if (!so_tien || parseFloat(so_tien) <= 0) {
            if (window.showModalValidationError) {
                window.showModalValidationError('so-tien-chi', 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá');
            }
            return;
        }
        
        if (!danh_muc) {
            if (window.showModalValidationError) {
                window.showModalValidationError('danh-muc-chi', 'Vui l√≤ng ch·ªçn danh m·ª•c');
            }
            return;
        }

        // Set loading state
        if (window.setButtonLoading) {
            window.setButtonLoading(submitButton, true);
        }

        const danh_muc_element = document.getElementById('danh-muc-chi');
        const danh_muc_text = danh_muc_element.options[danh_muc_element.selectedIndex].text;
        const tieu_de_tu_dong = danh_muc_text.replace(/^\S+\s/, ''); // X√≥a emoji v√† kho·∫£ng tr·∫Øng ƒë·∫ßu
        
        const du_lieu = {
            loai: 'chi',
            tieu_de: tieu_de_tu_dong,
            so_tien: parseFloat(so_tien),
            danh_muc: danh_muc,
            ngay_giao_dich: document.getElementById('ngay-chi').value,
            mo_ta: document.getElementById('mo-ta-chi').value
        };

        try {
            const response = await fetch('/api/thu-chi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(du_lieu)
            });

            const result = await response.json();
            
            if (result.thanh_cong) {
                hien_thi_thong_bao('ƒê√£ th√™m chi ti√™u m·ªõi!', 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-them-chi'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                form.reset();
                document.getElementById('ngay-chi').value = new Date().toISOString().split('T')[0];
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu ngay l·∫≠p t·ª©c
                await tai_danh_sach_thu_chi();
                await tinh_thong_ke();
                
                // N·∫øu ƒëang c√≥ b·ªô l·ªçc, √°p d·ª•ng l·∫°i b·ªô l·ªçc
                if (co_bo_loc_dang_hoat_dong()) {
                    loc_du_lieu();
                }
            } else {
                throw new Error(result.loi);
            }
        } catch (error) {
            console.error('L·ªói th√™m chi ti√™u:', error);
            hien_thi_thong_bao(`L·ªói: ${error.message}`, 'error');
        } finally {
            // Remove loading state
            if (window.setButtonLoading) {
                window.setButtonLoading(submitButton, false);
            }
        }
    }

    async function tinh_thong_ke() {
        try {
            const response = await fetch('/api/thu-chi/thong-ke');
            const data = await response.json();
            
            if (data.thanh_cong) {
                const thong_ke = data.du_lieu;
                // Hi·ªÉn th·ªã th·ªëng k√™ g·ªëc v·ªõi nh√£n th√°ng
                document.getElementById('tong-thu-thang').innerHTML = `
                    <small class="d-block text-white-50">Th√°ng n√†y</small>
                    ${dinh_dang_tien(thong_ke.tong_thu_thang)}
                `;
                document.getElementById('tong-chi-thang').innerHTML = `
                    <small class="d-block text-white-50">Th√°ng n√†y</small>
                    ${dinh_dang_tien(thong_ke.tong_chi_thang)}
                `;
                document.getElementById('so-du').innerHTML = `
                    <small class="d-block text-white-50">S·ªë d∆∞</small>
                    ${dinh_dang_tien(thong_ke.so_du)}
                `;
                document.getElementById('thu-hom-nay').innerHTML = `
                    <small class="d-block text-white-50">H√¥m nay</small>
                    ${dinh_dang_tien(thong_ke.thu_hom_nay)}
                `;
                document.getElementById('chi-hom-nay').innerHTML = `
                    <small class="d-block text-white-50">H√¥m nay</small>
                    ${dinh_dang_tien(thong_ke.chi_hom_nay)}
                `;
                document.getElementById('so-giao-dich').innerHTML = `
                    <small class="d-block text-white-50">T·ªïng</small>
                    ${thong_ke.so_giao_dich}
                `;
            } else {
                // Fallback v·ªõi d·ªØ li·ªáu m·∫´u n·∫øu API l·ªói
                document.getElementById('tong-thu-thang').innerHTML = '<small class="d-block text-white-50">Th√°ng n√†y</small>0 VNƒê';
                document.getElementById('tong-chi-thang').innerHTML = '<small class="d-block text-white-50">Th√°ng n√†y</small>0 VNƒê';
                document.getElementById('so-du').innerHTML = '<small class="d-block text-white-50">S·ªë d∆∞</small>0 VNƒê';
                document.getElementById('thu-hom-nay').innerHTML = '<small class="d-block text-white-50">H√¥m nay</small>0 VNƒê';
                document.getElementById('chi-hom-nay').innerHTML = '<small class="d-block text-white-50">H√¥m nay</small>0 VNƒê';
                document.getElementById('so-giao-dich').innerHTML = '<small class="d-block text-white-50">T·ªïng</small>0';
            }
        } catch (error) {
            console.error('L·ªói t√≠nh th·ªëng k√™:', error);
        }
    }

    function loc_du_lieu() {
        const loai = document.getElementById('loc-loai').value;
        const danh_muc = document.getElementById('loc-danh-muc').value;
        const tu_ngay = document.getElementById('tu-ngay').value;
        const den_ngay = document.getElementById('den-ngay').value;
        
        console.log('üîç B·ªô l·ªçc:', { loai, danh_muc, tu_ngay, den_ngay });
        
        // X√¢y d·ª±ng URL v·ªõi parameters
        let url = '/api/thu-chi?';
        const params = [];
        
        if (loai) params.push(`loai=${loai}`);
        if (danh_muc) params.push(`danh_muc=${danh_muc}`);
        if (tu_ngay) params.push(`tu_ngay=${tu_ngay}`);
        if (den_ngay) params.push(`den_ngay=${den_ngay}`);
        
        url += params.join('&');
        
        console.log('üåê URL API:', url);
        
        // G·ªçi API v·ªõi b·ªô l·ªçc
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('üìä D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', data);
                if (data.thanh_cong) {
                    hien_thi_danh_sach_thu_chi(data.du_lieu);
                    // C·∫≠p nh·∫≠t th·ªëng k√™ theo d·ªØ li·ªáu ƒë√£ l·ªçc
                    tinh_thong_ke_tu_du_lieu_loc(data.du_lieu);
                } else {
                    throw new Error(data.loi);
                }
            })
            .catch(error => {
                console.error('‚ùå L·ªói l·ªçc d·ªØ li·ªáu:', error);
                hien_thi_thong_bao('L·ªói khi l·ªçc d·ªØ li·ªáu', 'error');
            });
    }

    // Th√™m h√†m x√≥a b·ªô l·ªçc
    function xoa_bo_loc() {
        document.getElementById('loc-loai').value = '';
        document.getElementById('loc-danh-muc').value = '';
        document.getElementById('tu-ngay').value = '';
        document.getElementById('den-ngay').value = '';
        
        // T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu v√† th·ªëng k√™ g·ªëc
        tai_danh_sach_thu_chi();
        tinh_thong_ke();
    }

    // H√†m t√≠nh th·ªëng k√™ t·ª´ d·ªØ li·ªáu ƒë√£ l·ªçc
    function tinh_thong_ke_tu_du_lieu_loc(danh_sach_giao_dich) {
        const hom_nay = new Date().toISOString().split('T')[0];
        
        let tong_thu = 0;
        let tong_chi = 0;
        let thu_hom_nay = 0;
        let chi_hom_nay = 0;
        
        danh_sach_giao_dich.forEach(item => {
            const ngay_giao_dich = item.ngay_giao_dich || item.ngay_chi || item.ngay_tao;
            const so_tien = parseFloat(item.so_tien) || 0;
            
            if (item.loai === 'thu') {
                tong_thu += so_tien;
                if (ngay_giao_dich === hom_nay) {
                    thu_hom_nay += so_tien;
                }
            } else {
                tong_chi += so_tien;
                if (ngay_giao_dich === hom_nay) {
                    chi_hom_nay += so_tien;
                }
            }
        });
        
        const so_du = tong_thu - tong_chi;
        const so_giao_dich = danh_sach_giao_dich.length;
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã v·ªõi nh√£n "ƒê√£ l·ªçc"
        document.getElementById('tong-thu-thang').innerHTML = `
            <small class="d-block text-white-50">ƒê√£ l·ªçc</small>
            ${dinh_dang_tien(tong_thu)}
        `;
        document.getElementById('tong-chi-thang').innerHTML = `
            <small class="d-block text-white-50">ƒê√£ l·ªçc</small>
            ${dinh_dang_tien(tong_chi)}
        `;
        document.getElementById('so-du').innerHTML = `
            <small class="d-block text-white-50">ƒê√£ l·ªçc</small>
            ${dinh_dang_tien(so_du)}
        `;
        document.getElementById('thu-hom-nay').innerHTML = `
            <small class="d-block text-white-50">H√¥m nay</small>
            ${dinh_dang_tien(thu_hom_nay)}
        `;
        document.getElementById('chi-hom-nay').innerHTML = `
            <small class="d-block text-white-50">H√¥m nay</small>
            ${dinh_dang_tien(chi_hom_nay)}
        `;
        document.getElementById('so-giao-dich').innerHTML = `
            <small class="d-block text-white-50">ƒê√£ l·ªçc</small>
            ${so_giao_dich}
        `;
    }

    async function xoa_giao_dich(id) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a giao d·ªãch n√†y?')) {
            try {
                const response = await fetch(`/api/thu-chi/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.thanh_cong) {
                    hien_thi_thong_bao('ƒê√£ x√≥a giao d·ªãch th√†nh c√¥ng!', 'success');
                    
                    // C·∫≠p nh·∫≠t d·ªØ li·ªáu ngay l·∫≠p t·ª©c
                    await tai_danh_sach_thu_chi();
                    await tinh_thong_ke();
                    
                    // N·∫øu ƒëang c√≥ b·ªô l·ªçc, √°p d·ª•ng l·∫°i b·ªô l·ªçc
                    if (co_bo_loc_dang_hoat_dong()) {
                        loc_du_lieu();
                    }
                } else {
                    throw new Error(result.loi);
                }
            } catch (error) {
                hien_thi_thong_bao(`L·ªói khi x√≥a: ${error.message}`, 'error');
            }
        }
    }

    function lay_ten_danh_muc(danh_muc) {
        const danh_muc_map = {
            // Thu nh·∫≠p
            'luong': 'üí∞ L∆∞∆°ng',
            'thuong': 'üéÅ Th∆∞·ªüng',
            'dau-tu': 'üìà ƒê·∫ßu t∆∞',
            'ban-hang': 'üõçÔ∏è B√°n h√†ng',
            'thu-khac': 'üíµ Thu kh√°c',
            // Chi ti√™u
            'an-uong': 'üçΩÔ∏è ƒÇn u·ªëng',
            'di-chuyen': 'üöó Di chuy·ªÉn',
            'giai-tri': 'üéÆ Gi·∫£i tr√≠',
            'hoc-tap': 'üìö H·ªçc t·∫≠p',
            'suc-khoe': 'üíä S·ª©c kh·ªèe',
            'mua-sam': 'üõí Mua s·∫Øm',
            'chi-khac': 'üì¶ Chi kh√°c'
        };
        return danh_muc_map[danh_muc] || danh_muc;
    }

    function dinh_dang_tien(so_tien) {
        // S·ª≠ d·ª•ng h·ªá th·ªëng c√†i ƒë·∫∑t ti·ªÅn t·ªá m·ªõi
        if (window.dinh_dang_tien_te) {
            return window.dinh_dang_tien_te(so_tien);
        }
        
        // Fallback n·∫øu ch∆∞a load tien_te.js
        try {
            const cai_dat = JSON.parse(localStorage.getItem('cai_dat_tien_te')) || { don_vi: 'VND' };
            const don_vi = cai_dat.don_vi;
            
            const formatters = {
                'VND': new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }),
                'JPY': new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }),
                'USD': new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }),
                'EUR': new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' })
            };
            
            const formatter = formatters[don_vi] || formatters['VND'];
            return formatter.format(so_tien);
        } catch (error) {
            return so_tien.toLocaleString('vi-VN') + 'ƒë';
        }
    }

    function dinh_dang_ngay(ngay_str) {
        const ngay = new Date(ngay_str);
        return ngay.toLocaleDateString('vi-VN');
    }

    function hien_thi_thong_bao(thong_bao, loai) {
        // T·∫°o toast notification
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${loai === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${loai === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                    ${thong_bao}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // Th√™m v√†o container
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
        }
        
        container.appendChild(toast);
        
        // Hi·ªÉn th·ªã toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // T·ª± ƒë·ªông x√≥a sau khi ·∫©n
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }

    // ========================================
    // LOAD DANH M·ª§C THU CHI T·ª™ LOCALSTORAGE
    // ========================================
    
    /**
     * Load danh m·ª•c t·ª´ localStorage v√† c·∫≠p nh·∫≠t c√°c dropdown
     */
    function tai_danh_muc_tu_localStorage() {
        try {
            const danh_muc_luu = localStorage.getItem('danh_muc_thu_chi');
            let danh_muc;
            
            if (danh_muc_luu) {
                danh_muc = JSON.parse(danh_muc_luu);
                console.log('üü¢ Load danh m·ª•c t·ª´ localStorage:', danh_muc);
            } else {
                // S·ª≠ d·ª•ng danh m·ª•c m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
                danh_muc = {
                    thu: [
                        { id: 'luong', emoji: 'üí∞', ten: 'L∆∞∆°ng' },
                        { id: 'thuong', emoji: 'üéÅ', ten: 'Th∆∞·ªüng' },
                        { id: 'dau-tu', emoji: 'üìà', ten: 'ƒê·∫ßu t∆∞' },
                        { id: 'ban-hang', emoji: 'üõçÔ∏è', ten: 'B√°n h√†ng' },
                        { id: 'thu-khac', emoji: 'üíµ', ten: 'Thu kh√°c' }
                    ],
                    chi: [
                        { id: 'an-uong', emoji: 'üçΩÔ∏è', ten: 'ƒÇn u·ªëng' },
                        { id: 'di-chuyen', emoji: 'üöó', ten: 'Di chuy·ªÉn' },
                        { id: 'giai-tri', emoji: 'üéÆ', ten: 'Gi·∫£i tr√≠' },
                        { id: 'hoc-tap', emoji: 'üìö', ten: 'H·ªçc t·∫≠p' },
                        { id: 'suc-khoe', emoji: 'üíä', ten: 'S·ª©c kh·ªèe' },
                        { id: 'mua-sam', emoji: 'üõí', ten: 'Mua s·∫Øm' },
                        { id: 'chi-khac', emoji: 'üì¶', ten: 'Chi kh√°c' }
                    ]
                };
                console.log('üü° S·ª≠ d·ª•ng danh m·ª•c m·∫∑c ƒë·ªãnh:', danh_muc);
                // L∆∞u danh m·ª•c m·∫∑c ƒë·ªãnh v√†o localStorage
                localStorage.setItem('danh_muc_thu_chi', JSON.stringify(danh_muc));
            }
            
            // C·∫≠p nh·∫≠t dropdown danh m·ª•c thu
            cap_nhat_dropdown_danh_muc('danh-muc-thu', danh_muc.thu);
            
            // C·∫≠p nh·∫≠t dropdown danh m·ª•c chi
            cap_nhat_dropdown_danh_muc('danh-muc-chi', danh_muc.chi);
            
            // C·∫≠p nh·∫≠t dropdown l·ªçc (g·ªôp c·∫£ thu v√† chi)
            cap_nhat_dropdown_loc_danh_muc(danh_muc);
            
            console.log('‚úÖ ƒê√£ load danh m·ª•c th√†nh c√¥ng');
            
        } catch (error) {
            console.error('‚ùå L·ªói t·∫£i danh m·ª•c t·ª´ localStorage:', error);
        }
    }
    
    /**
     * C·∫≠p nh·∫≠t dropdown danh m·ª•c
     */
    function cap_nhat_dropdown_danh_muc(element_id, danh_sach) {
        const select_element = document.getElementById(element_id);
        if (!select_element) return;
        
        // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n (Ch·ªçn danh m·ª•c)
        const first_option = select_element.querySelector('option[value=""]');
        select_element.innerHTML = '';
        if (first_option) {
            select_element.appendChild(first_option);
        }
        
        // Th√™m c√°c option t·ª´ danh s√°ch
        danh_sach.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = `${item.emoji} ${item.ten}`;
            select_element.appendChild(option);
        });
    }
    
    /**
     * C·∫≠p nh·∫≠t dropdown l·ªçc danh m·ª•c (g·ªôp thu v√† chi)
     */
    function cap_nhat_dropdown_loc_danh_muc(danh_muc) {
        const select_element = document.getElementById('loc-danh-muc');
        if (!select_element) {
            console.error('‚ùå Kh√¥ng t√¨m th·∫•y element loc-danh-muc');
            return;
        }
        
        // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n (T·∫•t c·∫£)
        const first_option = select_element.querySelector('option[value=""]');
        select_element.innerHTML = '';
        if (first_option) {
            select_element.appendChild(first_option);
        } else {
            // T·∫°o option m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥
            const default_option = document.createElement('option');
            default_option.value = '';
            default_option.textContent = 'Danh m·ª•c';
            select_element.appendChild(default_option);
        }
        
        // Th√™m group Thu nh·∫≠p
        if (danh_muc.thu && danh_muc.thu.length > 0) {
            const optgroup_thu = document.createElement('optgroup');
            optgroup_thu.label = 'üü¢ Thu nh·∫≠p';
            danh_muc.thu.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.emoji} ${item.ten}`;
                optgroup_thu.appendChild(option);
            });
            select_element.appendChild(optgroup_thu);
        }
        
        // Th√™m group Chi ti√™u
        if (danh_muc.chi && danh_muc.chi.length > 0) {
            const optgroup_chi = document.createElement('optgroup');
            optgroup_chi.label = 'üî¥ Chi ti√™u';
            danh_muc.chi.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.emoji} ${item.ten}`;
                optgroup_chi.appendChild(option);
            });
            select_element.appendChild(optgroup_chi);
        }
        
        console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t dropdown l·ªçc danh m·ª•c:', select_element.children.length, 'options');
    }

    // H√†m ki·ªÉm tra c√≥ b·ªô l·ªçc ƒëang ho·∫°t ƒë·ªông
    function co_bo_loc_dang_hoat_dong() {
        const loai = document.getElementById('loc-loai').value;
        const danh_muc = document.getElementById('loc-danh-muc').value;
        const tu_ngay = document.getElementById('tu-ngay').value;
        const den_ngay = document.getElementById('den-ngay').value;
        
        return loai || danh_muc || tu_ngay || den_ngay;
    }
    
    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi ti·ªÅn t·ªá
    window.addEventListener('tien_te_thay_doi', function(event) {
        console.log('üîÑ Ti·ªÅn t·ªá ƒë√£ thay ƒë·ªïi, c·∫≠p nh·∫≠t hi·ªÉn th·ªã:', event.detail);
        tinh_thong_ke();
        if (window.danh_sach_thu_chi && window.danh_sach_thu_chi.length > 0) {
            hien_thi_danh_sach(window.danh_sach_thu_chi);
        }
    });
</script>

<!-- Script ti·ªÅn t·ªá -->
<script src="{{ url_for('static', filename='js/tien_te.js') }}"></script>

<!-- Modal fix cho mobile -->
<script src="{{ url_for('static', filename='js/modal_fix.js') }}"></script>
</div>
{% endblock %}
