{% extends "base.html" %}

{% block tieu_de %}Quản Lý Thu Chi{% endblock %}

{% block extra_css %}
<!-- Modal Fix CSS cho mobile/iOS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal_fix.css') }}">

<style>
/* CSS cập nhật - v2.0 */
/* CSS tùy chỉnh cho bảng chi tiêu responsive */
.card {
    overflow: hidden;
    border-radius: 8px;
    max-width: 100%;
    box-sizing: border-box;
}

.table-container {
    width: 100%;
    overflow: hidden;
    max-width: 100%;
    position: relative;
}

.table {
    width: 100% !important;
    table-layout: fixed;
    margin-bottom: 0;
    max-width: 100%;
    box-sizing: border-box;
}

.card-body {
    padding: 0 !important;
    overflow: hidden;
    max-width: 100%;
}

/* Force table to stay within bounds */
.table th,
.table td {
    box-sizing: border-box;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 0; /* Force ellipsis */
}

/* CSS riêng cho bảng thu chi */
.table-thu-chi {
    table-layout: fixed !important;
    width: 100% !important;
    border-collapse: collapse !important;
}

.table-thu-chi th,
.table-thu-chi td {
    padding: 0.5rem 0.3rem !important;
    font-size: 0.85rem !important;
    vertical-align: middle !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    max-width: 0 !important; /* Force text truncation */
    border: 1px solid #dee2e6 !important;
}

/* Desktop - 6 cột với text truncation */
.table-thu-chi th:nth-child(1), .table-thu-chi td:nth-child(1) { 
    width: 12% !important; 
    max-width: 12% !important;
} /* Ngày */

.table-thu-chi th:nth-child(2), .table-thu-chi td:nth-child(2) { 
    width: 10% !important; 
    max-width: 10% !important;
} /* Loại */

.table-thu-chi th:nth-child(3), .table-thu-chi td:nth-child(3) { 
    width: 25% !important; 
    max-width: 25% !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
} /* Tiêu đề - rút gọn khi dài */

.table-thu-chi th:nth-child(4), .table-thu-chi td:nth-child(4) { 
    width: 18% !important; 
    max-width: 18% !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
} /* Danh mục - rút gọn khi dài */

.table-thu-chi th:nth-child(5), .table-thu-chi td:nth-child(5) { 
    width: 20% !important; 
    max-width: 20% !important;
    text-align: right !important;
    white-space: nowrap !important;
} /* Số tiền */

.table-thu-chi th:nth-child(6), .table-thu-chi td:nth-child(6) { 
    width: 15% !important; 
    max-width: 15% !important;
    text-align: center !important;
} /* Thao tác */

@media screen and (max-width: 768px) {
    /* TEST: Màu nền để kiểm tra CSS mobile có áp dụng */
    body {
        background-color: #ffeeee !important;
    }
    
    /* Force CSS mobile cho bảng thu chi với specificity cao */
    .card .card-body .table-container .table-thu-chi {
        table-layout: fixed !important;
        width: 100% !important;
        font-size: 0.55rem !important;
        background-color: #ffffcc !important;
        border-collapse: collapse !important;
    }
    
    .card .card-body .table-container .table-thu-chi th,
    .card .card-body .table-container .table-thu-chi td {
        padding: 0.15rem 0.05rem !important;
        font-size: 0.5rem !important;
        line-height: 1.0 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 0 !important;
        border: 1px solid #ccc !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
    }
    
    /* Mobile - Force width cho từng cột */
    .card .card-body .table-container .table-thu-chi th:nth-child(1), 
    .card .card-body .table-container .table-thu-chi td:nth-child(1) { 
        width: 12% !important; 
        max-width: 12% !important;
        min-width: 12% !important;
        background-color: #ffcccc !important;
    } /* Ngày */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(2), 
    .card .card-body .table-container .table-thu-chi td:nth-child(2) { 
        width: 10% !important; 
        max-width: 10% !important;
        min-width: 10% !important;
        background-color: #ccffcc !important;
    } /* Loại */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(3), 
    .card .card-body .table-container .table-thu-chi td:nth-child(3) { 
        width: 25% !important; 
        max-width: 25% !important;
        min-width: 25% !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        background-color: #ccccff !important;
    } /* Tiêu đề */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(4), 
    .card .card-body .table-container .table-thu-chi td:nth-child(4) { 
        width: 15% !important; 
        max-width: 15% !important;
        min-width: 15% !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        background-color: #ffffcc !important;
    } /* Danh mục */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(5), 
    .card .card-body .table-container .table-thu-chi td:nth-child(5) { 
        width: 20% !important; 
        max-width: 20% !important;
        min-width: 20% !important;
        text-align: right !important;
        white-space: nowrap !important;
        background-color: #ffccff !important;
    } /* Số tiền */
    
    .card .card-body .table-container .table-thu-chi th:nth-child(6), 
    .card .card-body .table-container .table-thu-chi td:nth-child(6) { 
        width: 18% !important; 
        max-width: 18% !important;
        min-width: 18% !important;
        text-align: center !important;
        background-color: #ccffff !important;
    } /* Thao tác */
    
    /* Đảm bảo container không overflow trên mobile */
    .card {
        max-width: 100vw !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
        margin: 0 !important;
    }
    
    .table-container {
        width: 100% !important;
        overflow: hidden !important;
        max-width: 100% !important;
    }
    
    .card-body {
        padding: 0 !important;
        overflow: hidden !important;
        max-width: 100% !important;
    }
    
    /* Force table buttons nhỏ */
    .table-thu-chi .btn {
        padding: 0.1rem 0.15rem !important;
        font-size: 0.5rem !important;
        margin: 0 !important;
        min-width: auto !important;
        width: auto !important;
        line-height: 1 !important;
    }
    
    .table-thu-chi .btn i {
        font-size: 0.5rem !important;
    }
    
    /* Làm các button cực nhỏ */
    .table .btn {
        padding: 0.1rem 0.2rem !important;
        font-size: 0.55rem !important;
        margin: 0 !important;
        min-width: auto !important;
        width: auto !important;
    }
    
    .table .btn i {
        font-size: 0.6rem !important;
    }
    
    /* Force container width */
    .col-12 {
        max-width: 100% !important;
        overflow: hidden !important;
    }
    
    /* CSS cho nút Thu Nhập và Chi Tiêu sang phải trên mobile */
    .d-flex.gap-2 {
        justify-content: flex-end !important;
        margin-left: auto !important;
    }
    
    /* Đảm bảo header container responsive */
    .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.align-items-md-center.gap-2 {
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.align-items-md-center.gap-2 .d-flex.gap-2 {
        justify-content: flex-end !important;
        margin-left: auto !important;
        flex-shrink: 0 !important;
    }
}

@media (min-width: 769px) {
    .table th,
    .table td {
        padding: 0.5rem 0.3rem;
    }
    
    .table th:nth-child(1) { width: 12%; } /* Ngày */
    .table th:nth-child(2) { width: 10%; } /* Loại */
    .table th:nth-child(3) { width: 25%; } /* Tiêu đề */
    .table th:nth-child(4) { width: 18%; } /* Danh mục */
    .table th:nth-child(5) { width: 15%; } /* Số tiền */
    .table th:nth-child(6) { width: 20%; } /* Thao tác */
}

/* Đảm bảo không có overflow */
.container-fluid {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
    max-width: 100vw;
    overflow-x: hidden;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 0.25rem !important;
        padding-right: 0.25rem !important;
    }
    
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Force no horizontal scroll */
body {
    overflow-x: hidden;
}

html {
    overflow-x: hidden;
}
</style>
{% endblock %}

{% block noi_dung %}
<div class="chi-tieu-page">
<div class="container-fluid px-2 px-md-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <div>
                    <h1 class="h3 text-primary">
                        <i class="fas fa-chart-line me-2"></i>
                        <span>Quản Lý Thu Chi</span>
                    </h1>  
                </div>
                <div class="d-flex gap-2" style="margin-left: auto !important; justify-content: flex-end !important;">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-them-thu">
                        <i class="fas fa-plus me-1"></i>
                        <span class="d-none d-sm-inline">Thu Nhập</span>
                        <span class="d-sm-none">Thu</span>
                    </button>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modal-them-chi">
                        <i class="fas fa-minus me-1"></i>
                        <span class="d-none d-sm-inline">Chi Tiêu</span>
                        <span class="d-sm-none">Chi</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Thống kê nhanh -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Thu Nhập</h6>
                    <p class="card-text h5" id="tong-thu-thang">
                        <small class="d-block text-white-50">Tháng này</small>
                        0 VNĐ
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Chi Tiêu</h6>
                    <p class="card-text h5" id="tong-chi-thang">
                        <small class="d-block text-white-50">Tháng này</small>
                        0 VNĐ
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Số Dư</h6>
                    <p class="card-text h5" id="so-du">
                        <small class="d-block text-white-50">Số dư</small>
                        0 VNĐ
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Thu Hôm Nay</h6>
                    <p class="card-text h5" id="thu-hom-nay">
                        <small class="d-block text-white-50">Hôm nay</small>
                        0 VNĐ
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Chi Hôm Nay</h6>
                    <p class="card-text h5" id="chi-hom-nay">
                        <small class="d-block text-white-50">Hôm nay</small>
                        0 VNĐ
                    </p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-2">
            <div class="card text-center bg-secondary text-white">
                <div class="card-body">
                    <h6 class="card-title">Giao Dịch</h6>
                    <p class="card-text h5" id="so-giao-dich">
                        <small class="d-block text-white-50">Tổng</small>
                        0
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách thu chi -->
    <div class="row mx-0">
        <div class="col-12 px-1 px-md-3">
            <div class="card mx-0">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                    <h5 class="card-title mb-0 mb-md-0">
                        <i class="fas fa-list me-2"></i>
                        Danh Sách Thu Chi
                    </h5>
                    <!-- Bộ lọc nhỏ gọn bên góc phải -->
                    <div class="d-flex gap-1 gap-md-2 align-items-center flex-wrap">
                        <select class="form-select form-select-sm" id="loc-loai" style="width: 75px;" onchange="loc_du_lieu()">
                            <option value="">Tất cả</option>
                            <option value="thu">Thu nhập</option>
                            <option value="chi">Chi tiêu</option>
                        </select>
                        <select class="form-select form-select-sm" id="loc-danh-muc" style="width: 100px;" onchange="loc_du_lieu()">
                            <option value="">Danh mục</option>
                            <!-- Sẽ được load từ localStorage bằng JavaScript -->
                        </select>
                        <input type="date" class="form-control form-control-sm d-none d-md-inline" id="tu-ngay" style="width: 125px;" onchange="loc_du_lieu()" title="Từ ngày" placeholder="Từ ngày">
                        <input type="date" class="form-control form-control-sm d-none d-md-inline" id="den-ngay" style="width: 125px;" onchange="loc_du_lieu()" title="Đến ngày" placeholder="Đến ngày">
                        <button class="btn btn-outline-secondary btn-sm" onclick="xoa_bo_loc()" title="Xóa bộ lọc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-container">
                        <table class="table table-hover w-100 mb-0 table-thu-chi" style="table-layout: fixed !important; width: 100% !important; font-size: 0.55rem;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 12% !important; max-width: 12% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Ngày</th>
                                    <th style="width: 10% !important; max-width: 10% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Loại</th>
                                    <th style="width: 25% !important; max-width: 25% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Tiêu đề</th>
                                    <th style="width: 15% !important; max-width: 15% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Danh mục</th>
                                    <th style="width: 20% !important; max-width: 20% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: right;">Số tiền</th>
                                    <th style="width: 18% !important; max-width: 18% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="danh-sach-thu-chi">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm thu nhập -->
<div class="modal fade" id="modal-them-thu" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>
                    Thêm Thu Nhập
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-them-thu">
                    <div class="mb-3">
                        <label class="form-label">Số tiền <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="so-tien-thu" placeholder="0" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select class="form-control" id="danh-muc-thu" required>
                            <option value="">Chọn danh mục</option>
                            <!-- Sẽ được load từ localStorage bằng JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ngày thu</label>
                        <input type="date" class="form-control" id="ngay-thu">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="mo-ta-thu" rows="3" placeholder="Mô tả chi tiết (tùy chọn)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="them_thu_nhap()">
                    <i class="fas fa-save me-1"></i>Lưu Thu Nhập
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm chi tiêu -->
<div class="modal fade" id="modal-them-chi" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-minus-circle me-2"></i>
                    Thêm Chi Tiêu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-them-chi">
                    <div class="mb-3">
                        <label class="form-label">Số tiền <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="so-tien-chi" placeholder="0" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select class="form-control" id="danh-muc-chi" required>
                            <option value="">Chọn danh mục</option>
                            <!-- Sẽ được load từ localStorage bằng JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ngày chi</label>
                        <input type="date" class="form-control" id="ngay-chi">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="mo-ta-chi" rows="3" placeholder="Mô tả chi tiết (tùy chọn)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="them_chi_tieu()">
                    <i class="fas fa-save me-1"></i>Lưu Chi Tiêu
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    // Khởi tạo khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        // Đặt ngày mặc định là hôm nay
        const hom_nay = new Date().toISOString().split('T')[0];
        document.getElementById('ngay-thu').value = hom_nay;
        document.getElementById('ngay-chi').value = hom_nay;
        document.getElementById('den-ngay').value = hom_nay;
        
        // Đặt từ ngày là đầu tháng
        const dau_thang = new Date();
        dau_thang.setDate(1);
        document.getElementById('tu-ngay').value = dau_thang.toISOString().split('T')[0];
        
        // Load danh mục từ localStorage trước
        tai_danh_muc_tu_localStorage();
        
        // Tải dữ liệu
        tai_danh_sach_thu_chi();
        tinh_thong_ke();
        
        // Lắng nghe thay đổi cài đặt toàn cục
        window.addEventListener('settingsChanged', function(event) {
            // Reload lại thống kê để format lại tiền tệ
            tinh_thong_ke();
            // Reload lại danh sách để format lại
            tai_danh_sach_thu_chi();
        });
    });

    async function tai_danh_sach_thu_chi() {
        try {
            const response = await fetch('/api/thu-chi');
            const data = await response.json();
            
            if (data.thanh_cong) {
                hien_thi_danh_sach_thu_chi(data.du_lieu);
            } else {
                throw new Error(data.loi);
            }
        } catch (error) {
            console.error('Lỗi tải danh sách thu chi:', error);
            document.getElementById('danh-sach-thu-chi').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Lỗi tải dữ liệu: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function hien_thi_danh_sach_thu_chi(danh_sach) {
        const tbody = document.getElementById('danh-sach-thu-chi');
        
        if (danh_sach.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                        <p class="text-muted">Chưa có giao dịch nào</p>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modal-them-thu">
                                <i class="fas fa-plus me-1"></i>Thu nhập
                            </button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modal-them-chi">
                                <i class="fas fa-minus me-1"></i>Chi tiêu
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // Sắp xếp theo ngày mới nhất trước
        danh_sach.sort((a, b) => {
            const ngay_a = new Date(a.ngay_giao_dich || a.ngay_chi || a.ngay_tao);
            const ngay_b = new Date(b.ngay_giao_dich || b.ngay_chi || b.ngay_tao);
            return ngay_b - ngay_a; // Ngày mới nhất trước
        });

        tbody.innerHTML = danh_sach.map(item => {
            // Xác định loại giao dịch từ dữ liệu hoặc mặc định là chi tiêu
            const loai = item.loai || 'chi';
            const ngay_hien_thi = item.ngay_giao_dich || item.ngay_chi || item.ngay_tao;
            
            return `
            <tr>
                <td style="width: 12% !important; max-width: 12% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <small>${dinh_dang_ngay(ngay_hien_thi)}</small>
                </td>
                <td style="width: 10% !important; max-width: 10% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <span class="badge ${loai === 'thu' ? 'bg-success' : 'bg-danger'}">
                        <i class="fas ${loai === 'thu' ? 'fa-plus' : 'fa-minus'} me-1"></i>
                        ${loai === 'thu' ? 'Thu' : 'Chi'}
                    </span>
                </td>
                <td title="${item.tieu_de}" style="width: 25% !important; max-width: 25% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <strong>${item.tieu_de}</strong>
                    ${item.mo_ta ? `<br><small class="text-muted">${item.mo_ta}</small>` : ''}
                </td>
                <td title="${lay_ten_danh_muc(item.danh_muc)}" style="width: 15% !important; max-width: 15% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <span class="badge bg-secondary">${lay_ten_danh_muc(item.danh_muc)}</span>
                </td>
                <td style="width: 20% !important; max-width: 20% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: right;">
                    <strong class="${loai === 'thu' ? 'text-success' : 'text-danger'}">
                        ${loai === 'thu' ? '+' : '-'}${dinh_dang_tien(item.so_tien)}
                    </strong>
                </td>
                <td style="width: 18% !important; max-width: 18% !important; padding: 0.15rem 0.05rem !important; font-size: 0.5rem !important; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;">
                    <button class="btn btn-sm btn-outline-danger" onclick="xoa_giao_dich(${item.id})" style="padding: 0.1rem 0.15rem !important; font-size: 0.45rem !important;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    async function them_thu_nhap() {
        const form = document.getElementById('form-them-thu');
        const submitButton = document.querySelector('#modal-them-thu .btn-success');
        
        // Clear previous validation errors
        if (window.clearModalValidationErrors) {
            window.clearModalValidationErrors('form-them-thu');
        }
        
        // Validation
        const so_tien = document.getElementById('so-tien-thu').value;
        const danh_muc = document.getElementById('danh-muc-thu').value;
        
        if (!so_tien || parseFloat(so_tien) <= 0) {
            if (window.showModalValidationError) {
                window.showModalValidationError('so-tien-thu', 'Vui lòng nhập số tiền hợp lệ');
            }
            return;
        }
        
        if (!danh_muc) {
            if (window.showModalValidationError) {
                window.showModalValidationError('danh-muc-thu', 'Vui lòng chọn danh mục');
            }
            return;
        }

        // Set loading state
        if (window.setButtonLoading) {
            window.setButtonLoading(submitButton, true);
        }

        const danh_muc_element = document.getElementById('danh-muc-thu');
        const danh_muc_text = danh_muc_element.options[danh_muc_element.selectedIndex].text;
        const tieu_de_tu_dong = danh_muc_text.replace(/^\S+\s/, ''); // Xóa emoji và khoảng trắng đầu
        
        const du_lieu = {
            loai: 'thu',
            tieu_de: tieu_de_tu_dong,
            so_tien: parseFloat(so_tien),
            danh_muc: danh_muc,
            ngay_giao_dich: document.getElementById('ngay-thu').value,
            mo_ta: document.getElementById('mo-ta-thu').value
        };

        try {
            const response = await fetch('/api/thu-chi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(du_lieu)
            });

            const result = await response.json();
            
            if (result.thanh_cong) {
                hien_thi_thong_bao('Đã thêm thu nhập mới!', 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-them-thu'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                form.reset();
                document.getElementById('ngay-thu').value = new Date().toISOString().split('T')[0];
                
                // Cập nhật dữ liệu ngay lập tức
                await tai_danh_sach_thu_chi();
                await tinh_thong_ke();
                
                // Nếu đang có bộ lọc, áp dụng lại bộ lọc
                if (co_bo_loc_dang_hoat_dong()) {
                    loc_du_lieu();
                }
            } else {
                throw new Error(result.loi);
            }
        } catch (error) {
            console.error('Lỗi thêm thu nhập:', error);
            hien_thi_thong_bao(`Lỗi: ${error.message}`, 'error');
        } finally {
            // Remove loading state
            if (window.setButtonLoading) {
                window.setButtonLoading(submitButton, false);
            }
        }
    }

    async function them_chi_tieu() {
        const form = document.getElementById('form-them-chi');
        const submitButton = document.querySelector('#modal-them-chi .btn-danger');
        
        // Clear previous validation errors
        if (window.clearModalValidationErrors) {
            window.clearModalValidationErrors('form-them-chi');
        }
        
        // Validation
        const so_tien = document.getElementById('so-tien-chi').value;
        const danh_muc = document.getElementById('danh-muc-chi').value;
        
        if (!so_tien || parseFloat(so_tien) <= 0) {
            if (window.showModalValidationError) {
                window.showModalValidationError('so-tien-chi', 'Vui lòng nhập số tiền hợp lệ');
            }
            return;
        }
        
        if (!danh_muc) {
            if (window.showModalValidationError) {
                window.showModalValidationError('danh-muc-chi', 'Vui lòng chọn danh mục');
            }
            return;
        }

        // Set loading state
        if (window.setButtonLoading) {
            window.setButtonLoading(submitButton, true);
        }

        const danh_muc_element = document.getElementById('danh-muc-chi');
        const danh_muc_text = danh_muc_element.options[danh_muc_element.selectedIndex].text;
        const tieu_de_tu_dong = danh_muc_text.replace(/^\S+\s/, ''); // Xóa emoji và khoảng trắng đầu
        
        const du_lieu = {
            loai: 'chi',
            tieu_de: tieu_de_tu_dong,
            so_tien: parseFloat(so_tien),
            danh_muc: danh_muc,
            ngay_giao_dich: document.getElementById('ngay-chi').value,
            mo_ta: document.getElementById('mo-ta-chi').value
        };

        try {
            const response = await fetch('/api/thu-chi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(du_lieu)
            });

            const result = await response.json();
            
            if (result.thanh_cong) {
                hien_thi_thong_bao('Đã thêm chi tiêu mới!', 'success');
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-them-chi'));
                if (modal) {
                    modal.hide();
                }
                
                // Reset form
                form.reset();
                document.getElementById('ngay-chi').value = new Date().toISOString().split('T')[0];
                
                // Cập nhật dữ liệu ngay lập tức
                await tai_danh_sach_thu_chi();
                await tinh_thong_ke();
                
                // Nếu đang có bộ lọc, áp dụng lại bộ lọc
                if (co_bo_loc_dang_hoat_dong()) {
                    loc_du_lieu();
                }
            } else {
                throw new Error(result.loi);
            }
        } catch (error) {
            console.error('Lỗi thêm chi tiêu:', error);
            hien_thi_thong_bao(`Lỗi: ${error.message}`, 'error');
        } finally {
            // Remove loading state
            if (window.setButtonLoading) {
                window.setButtonLoading(submitButton, false);
            }
        }
    }

    async function tinh_thong_ke() {
        try {
            const response = await fetch('/api/thu-chi/thong-ke');
            const data = await response.json();
            
            if (data.thanh_cong) {
                const thong_ke = data.du_lieu;
                // Hiển thị thống kê gốc với nhãn tháng
                document.getElementById('tong-thu-thang').innerHTML = `
                    <small class="d-block text-white-50">Tháng này</small>
                    ${dinh_dang_tien(thong_ke.tong_thu_thang)}
                `;
                document.getElementById('tong-chi-thang').innerHTML = `
                    <small class="d-block text-white-50">Tháng này</small>
                    ${dinh_dang_tien(thong_ke.tong_chi_thang)}
                `;
                document.getElementById('so-du').innerHTML = `
                    <small class="d-block text-white-50">Số dư</small>
                    ${dinh_dang_tien(thong_ke.so_du)}
                `;
                document.getElementById('thu-hom-nay').innerHTML = `
                    <small class="d-block text-white-50">Hôm nay</small>
                    ${dinh_dang_tien(thong_ke.thu_hom_nay)}
                `;
                document.getElementById('chi-hom-nay').innerHTML = `
                    <small class="d-block text-white-50">Hôm nay</small>
                    ${dinh_dang_tien(thong_ke.chi_hom_nay)}
                `;
                document.getElementById('so-giao-dich').innerHTML = `
                    <small class="d-block text-white-50">Tổng</small>
                    ${thong_ke.so_giao_dich}
                `;
            } else {
                // Fallback với dữ liệu mẫu nếu API lỗi
                document.getElementById('tong-thu-thang').innerHTML = '<small class="d-block text-white-50">Tháng này</small>0 VNĐ';
                document.getElementById('tong-chi-thang').innerHTML = '<small class="d-block text-white-50">Tháng này</small>0 VNĐ';
                document.getElementById('so-du').innerHTML = '<small class="d-block text-white-50">Số dư</small>0 VNĐ';
                document.getElementById('thu-hom-nay').innerHTML = '<small class="d-block text-white-50">Hôm nay</small>0 VNĐ';
                document.getElementById('chi-hom-nay').innerHTML = '<small class="d-block text-white-50">Hôm nay</small>0 VNĐ';
                document.getElementById('so-giao-dich').innerHTML = '<small class="d-block text-white-50">Tổng</small>0';
            }
        } catch (error) {
            console.error('Lỗi tính thống kê:', error);
        }
    }

    function loc_du_lieu() {
        const loai = document.getElementById('loc-loai').value;
        const danh_muc = document.getElementById('loc-danh-muc').value;
        const tu_ngay = document.getElementById('tu-ngay').value;
        const den_ngay = document.getElementById('den-ngay').value;
        
        console.log('🔍 Bộ lọc:', { loai, danh_muc, tu_ngay, den_ngay });
        
        // Xây dựng URL với parameters
        let url = '/api/thu-chi?';
        const params = [];
        
        if (loai) params.push(`loai=${loai}`);
        if (danh_muc) params.push(`danh_muc=${danh_muc}`);
        if (tu_ngay) params.push(`tu_ngay=${tu_ngay}`);
        if (den_ngay) params.push(`den_ngay=${den_ngay}`);
        
        url += params.join('&');
        
        console.log('🌐 URL API:', url);
        
        // Gọi API với bộ lọc
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('📊 Dữ liệu nhận được:', data);
                if (data.thanh_cong) {
                    hien_thi_danh_sach_thu_chi(data.du_lieu);
                    // Cập nhật thống kê theo dữ liệu đã lọc
                    tinh_thong_ke_tu_du_lieu_loc(data.du_lieu);
                } else {
                    throw new Error(data.loi);
                }
            })
            .catch(error => {
                console.error('❌ Lỗi lọc dữ liệu:', error);
                hien_thi_thong_bao('Lỗi khi lọc dữ liệu', 'error');
            });
    }

    // Thêm hàm xóa bộ lọc
    function xoa_bo_loc() {
        document.getElementById('loc-loai').value = '';
        document.getElementById('loc-danh-muc').value = '';
        document.getElementById('tu-ngay').value = '';
        document.getElementById('den-ngay').value = '';
        
        // Tải lại toàn bộ dữ liệu và thống kê gốc
        tai_danh_sach_thu_chi();
        tinh_thong_ke();
    }

    // Hàm tính thống kê từ dữ liệu đã lọc
    function tinh_thong_ke_tu_du_lieu_loc(danh_sach_giao_dich) {
        const hom_nay = new Date().toISOString().split('T')[0];
        
        let tong_thu = 0;
        let tong_chi = 0;
        let thu_hom_nay = 0;
        let chi_hom_nay = 0;
        
        danh_sach_giao_dich.forEach(item => {
            const ngay_giao_dich = item.ngay_giao_dich || item.ngay_chi || item.ngay_tao;
            const so_tien = parseFloat(item.so_tien) || 0;
            
            if (item.loai === 'thu') {
                tong_thu += so_tien;
                if (ngay_giao_dich === hom_nay) {
                    thu_hom_nay += so_tien;
                }
            } else {
                tong_chi += so_tien;
                if (ngay_giao_dich === hom_nay) {
                    chi_hom_nay += so_tien;
                }
            }
        });
        
        const so_du = tong_thu - tong_chi;
        const so_giao_dich = danh_sach_giao_dich.length;
        
        // Cập nhật hiển thị với nhãn "Đã lọc"
        document.getElementById('tong-thu-thang').innerHTML = `
            <small class="d-block text-white-50">Đã lọc</small>
            ${dinh_dang_tien(tong_thu)}
        `;
        document.getElementById('tong-chi-thang').innerHTML = `
            <small class="d-block text-white-50">Đã lọc</small>
            ${dinh_dang_tien(tong_chi)}
        `;
        document.getElementById('so-du').innerHTML = `
            <small class="d-block text-white-50">Đã lọc</small>
            ${dinh_dang_tien(so_du)}
        `;
        document.getElementById('thu-hom-nay').innerHTML = `
            <small class="d-block text-white-50">Hôm nay</small>
            ${dinh_dang_tien(thu_hom_nay)}
        `;
        document.getElementById('chi-hom-nay').innerHTML = `
            <small class="d-block text-white-50">Hôm nay</small>
            ${dinh_dang_tien(chi_hom_nay)}
        `;
        document.getElementById('so-giao-dich').innerHTML = `
            <small class="d-block text-white-50">Đã lọc</small>
            ${so_giao_dich}
        `;
    }

    async function xoa_giao_dich(id) {
        if (confirm('Bạn có chắc muốn xóa giao dịch này?')) {
            try {
                const response = await fetch(`/api/thu-chi/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.thanh_cong) {
                    hien_thi_thong_bao('Đã xóa giao dịch thành công!', 'success');
                    
                    // Cập nhật dữ liệu ngay lập tức
                    await tai_danh_sach_thu_chi();
                    await tinh_thong_ke();
                    
                    // Nếu đang có bộ lọc, áp dụng lại bộ lọc
                    if (co_bo_loc_dang_hoat_dong()) {
                        loc_du_lieu();
                    }
                } else {
                    throw new Error(result.loi);
                }
            } catch (error) {
                hien_thi_thong_bao(`Lỗi khi xóa: ${error.message}`, 'error');
            }
        }
    }

    function lay_ten_danh_muc(danh_muc) {
        const danh_muc_map = {
            // Thu nhập
            'luong': '💰 Lương',
            'thuong': '🎁 Thưởng',
            'dau-tu': '📈 Đầu tư',
            'ban-hang': '🛍️ Bán hàng',
            'thu-khac': '💵 Thu khác',
            // Chi tiêu
            'an-uong': '🍽️ Ăn uống',
            'di-chuyen': '🚗 Di chuyển',
            'giai-tri': '🎮 Giải trí',
            'hoc-tap': '📚 Học tập',
            'suc-khoe': '💊 Sức khỏe',
            'mua-sam': '🛒 Mua sắm',
            'chi-khac': '📦 Chi khác'
        };
        return danh_muc_map[danh_muc] || danh_muc;
    }

    function dinh_dang_tien(so_tien) {
        // Sử dụng hệ thống cài đặt tiền tệ mới
        if (window.dinh_dang_tien_te) {
            return window.dinh_dang_tien_te(so_tien);
        }
        
        // Fallback nếu chưa load tien_te.js
        try {
            const cai_dat = JSON.parse(localStorage.getItem('cai_dat_tien_te')) || { don_vi: 'VND' };
            const don_vi = cai_dat.don_vi;
            
            const formatters = {
                'VND': new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }),
                'JPY': new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }),
                'USD': new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }),
                'EUR': new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' })
            };
            
            const formatter = formatters[don_vi] || formatters['VND'];
            return formatter.format(so_tien);
        } catch (error) {
            return so_tien.toLocaleString('vi-VN') + 'đ';
        }
    }

    function dinh_dang_ngay(ngay_str) {
        const ngay = new Date(ngay_str);
        return ngay.toLocaleDateString('vi-VN');
    }

    function hien_thi_thong_bao(thong_bao, loai) {
        // Tạo toast notification
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${loai === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${loai === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                    ${thong_bao}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // Thêm vào container
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
        }
        
        container.appendChild(toast);
        
        // Hiển thị toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Tự động xóa sau khi ẩn
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }

    // ========================================
    // LOAD DANH MỤC THU CHI TỪ LOCALSTORAGE
    // ========================================
    
    /**
     * Load danh mục từ localStorage và cập nhật các dropdown
     */
    function tai_danh_muc_tu_localStorage() {
        try {
            const danh_muc_luu = localStorage.getItem('danh_muc_thu_chi');
            let danh_muc;
            
            if (danh_muc_luu) {
                danh_muc = JSON.parse(danh_muc_luu);
                console.log('🟢 Load danh mục từ localStorage:', danh_muc);
            } else {
                // Sử dụng danh mục mặc định nếu chưa có
                danh_muc = {
                    thu: [
                        { id: 'luong', emoji: '💰', ten: 'Lương' },
                        { id: 'thuong', emoji: '🎁', ten: 'Thưởng' },
                        { id: 'dau-tu', emoji: '📈', ten: 'Đầu tư' },
                        { id: 'ban-hang', emoji: '🛍️', ten: 'Bán hàng' },
                        { id: 'thu-khac', emoji: '💵', ten: 'Thu khác' }
                    ],
                    chi: [
                        { id: 'an-uong', emoji: '🍽️', ten: 'Ăn uống' },
                        { id: 'di-chuyen', emoji: '🚗', ten: 'Di chuyển' },
                        { id: 'giai-tri', emoji: '🎮', ten: 'Giải trí' },
                        { id: 'hoc-tap', emoji: '📚', ten: 'Học tập' },
                        { id: 'suc-khoe', emoji: '💊', ten: 'Sức khỏe' },
                        { id: 'mua-sam', emoji: '🛒', ten: 'Mua sắm' },
                        { id: 'chi-khac', emoji: '📦', ten: 'Chi khác' }
                    ]
                };
                console.log('🟡 Sử dụng danh mục mặc định:', danh_muc);
                // Lưu danh mục mặc định vào localStorage
                localStorage.setItem('danh_muc_thu_chi', JSON.stringify(danh_muc));
            }
            
            // Cập nhật dropdown danh mục thu
            cap_nhat_dropdown_danh_muc('danh-muc-thu', danh_muc.thu);
            
            // Cập nhật dropdown danh mục chi
            cap_nhat_dropdown_danh_muc('danh-muc-chi', danh_muc.chi);
            
            // Cập nhật dropdown lọc (gộp cả thu và chi)
            cap_nhat_dropdown_loc_danh_muc(danh_muc);
            
            console.log('✅ Đã load danh mục thành công');
            
        } catch (error) {
            console.error('❌ Lỗi tải danh mục từ localStorage:', error);
        }
    }
    
    /**
     * Cập nhật dropdown danh mục
     */
    function cap_nhat_dropdown_danh_muc(element_id, danh_sach) {
        const select_element = document.getElementById(element_id);
        if (!select_element) return;
        
        // Giữ lại option đầu tiên (Chọn danh mục)
        const first_option = select_element.querySelector('option[value=""]');
        select_element.innerHTML = '';
        if (first_option) {
            select_element.appendChild(first_option);
        }
        
        // Thêm các option từ danh sách
        danh_sach.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = `${item.emoji} ${item.ten}`;
            select_element.appendChild(option);
        });
    }
    
    /**
     * Cập nhật dropdown lọc danh mục (gộp thu và chi)
     */
    function cap_nhat_dropdown_loc_danh_muc(danh_muc) {
        const select_element = document.getElementById('loc-danh-muc');
        if (!select_element) {
            console.error('❌ Không tìm thấy element loc-danh-muc');
            return;
        }
        
        // Giữ lại option đầu tiên (Tất cả)
        const first_option = select_element.querySelector('option[value=""]');
        select_element.innerHTML = '';
        if (first_option) {
            select_element.appendChild(first_option);
        } else {
            // Tạo option mặc định nếu không có
            const default_option = document.createElement('option');
            default_option.value = '';
            default_option.textContent = 'Danh mục';
            select_element.appendChild(default_option);
        }
        
        // Thêm group Thu nhập
        if (danh_muc.thu && danh_muc.thu.length > 0) {
            const optgroup_thu = document.createElement('optgroup');
            optgroup_thu.label = '🟢 Thu nhập';
            danh_muc.thu.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.emoji} ${item.ten}`;
                optgroup_thu.appendChild(option);
            });
            select_element.appendChild(optgroup_thu);
        }
        
        // Thêm group Chi tiêu
        if (danh_muc.chi && danh_muc.chi.length > 0) {
            const optgroup_chi = document.createElement('optgroup');
            optgroup_chi.label = '🔴 Chi tiêu';
            danh_muc.chi.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.emoji} ${item.ten}`;
                optgroup_chi.appendChild(option);
            });
            select_element.appendChild(optgroup_chi);
        }
        
        console.log('✅ Đã cập nhật dropdown lọc danh mục:', select_element.children.length, 'options');
    }

    // Hàm kiểm tra có bộ lọc đang hoạt động
    function co_bo_loc_dang_hoat_dong() {
        const loai = document.getElementById('loc-loai').value;
        const danh_muc = document.getElementById('loc-danh-muc').value;
        const tu_ngay = document.getElementById('tu-ngay').value;
        const den_ngay = document.getElementById('den-ngay').value;
        
        return loai || danh_muc || tu_ngay || den_ngay;
    }
    
    // Lắng nghe sự kiện thay đổi tiền tệ
    window.addEventListener('tien_te_thay_doi', function(event) {
        console.log('🔄 Tiền tệ đã thay đổi, cập nhật hiển thị:', event.detail);
        tinh_thong_ke();
        if (window.danh_sach_thu_chi && window.danh_sach_thu_chi.length > 0) {
            hien_thi_danh_sach(window.danh_sach_thu_chi);
        }
    });
</script>

<!-- Script tiền tệ -->
<script src="{{ url_for('static', filename='js/tien_te.js') }}"></script>

<!-- Modal fix cho mobile -->
<script src="{{ url_for('static', filename='js/modal_fix.js') }}"></script>
</div>
{% endblock %}
